<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucia Baby Log Input</title>
	<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
	<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <button id="toggle-button" onclick="toggleView()">Show Stats</button>
    
    <div id="log-content" class="tab-content active">

        <h1>Lucia Baby Log Input</h1>
        <div class="form-group">
            <label for="time">Select Time: </label>
            <input type="datetime-local" id="time" name="time">
        </div>
        <div class="form-group">
           <select id="activity">
    			<option value="" disabled selected>CHOOSE ACTIVITY</option>
    			<option value="asleep">Asleep</option>
    			<option value="awake">Awake</option>
    			<option value="wet diaper">Wet Diaper</option>
    			<option value="poo diaper">Poo Diaper</option>
    			<option value="mixed diaper">Mixed Diaper</option>
    			<option value="playing">Playing</option>
    			<option value="feeding">Feeding</option>
    			<option value="bathing">Bathing</option> 
    		</select>
        </div>
        <div class="form-group">
            <input type="text" id="notes" placeholder="Add a short note (e.g., 60mL)">
        </div>
        
        <!-- Button group with equal-sized buttons in one row -->
        <div class="button-group">
            <button onclick="addActivity()">Add Activity</button>
            <button onclick="loadLog()">Refresh Log</button>
            <button onclick="sortLog()">Sort Log</button>
        </div>
        <!-- New button to edit the log -->
        <button id="edit-log-btn" class="edit-log-btn" onclick="toggleEditLog()">Edit Log</button>
    
        <!-- Log text -->
        <div id="log"></div>
    	<textarea id="log-textarea"></textarea>
    </div>
    
     <!-- Stats Content -->
    <div id="stats-content" class="tab-content">
        <h2 class="stats-heading">Daily Totals</h2>
        <div class="stats-grid">
            <div class="stat-box" id="diaper-stats-box">No data</div>
            <div class="stat-box" id="nap-stats-box">No data</div>
            <div class="stat-box" id="nap-count-box">No data</div>
            <div class="stat-box" id="nap-time-box">No data</div>
            <div class="stat-box" id="feeding-count-box">No data</div>
            <div class="stat-box" id="feeding-amount-box">No data</div>
        </div>
        <h2 class="stats-heading">Weekly Average</h2>
        <div class="stats-grid">
            <div class="stat-box">Diapers</div>
            <div class="stat-box">Nap Time</div>
            <div class="stat-box"># of Naps</div>
            <div class="stat-box">Feeding Sessions</div>
            <div class="stat-box">Feeding Amounts</div>
        </div>
        <h2 class="stats-heading">All-time Totals</h2>
        <div class="stats-grid">
            <div class="stat-box">Diapers</div>
            <div class="stat-box">Nap Time</div>
            <div class="stat-box"># of Naps</div>
            <div class="stat-box">Feeding Sessions</div>
            <div class="stat-box">Feeding Amounts</div>
        </div>
    </div>

    <script>
		let isEditing = false; // Track editing state
		
		function toggleView() {
            // Get the button and the two content areas
            const toggleButton = document.getElementById('toggle-button');
            const logContent = document.getElementById('log-content');
            const statsContent = document.getElementById('stats-content');

            // Check which view is currently active and toggle
            if (logContent.classList.contains('active')) {
                // Hide the log and show the stats
                logContent.classList.remove('active');
                statsContent.classList.add('active');
                // Change the button text and style
                toggleButton.textContent = 'Show Log';
                toggleButton.classList.add('stats-view');
                
                // Calculate stats
                // Load all stats using the single function
                loadDailyStats();
            } else {
                // Hide the stats and show the log
                statsContent.classList.remove('active');
                logContent.classList.add('active');
                // Change the button text and style
                toggleButton.textContent = 'Show Stats';
                toggleButton.classList.remove('stats-view');
            }
        }

        // Function to toggle between viewing and editing the log
        function toggleEditLog() {
            const logElement = document.getElementById('log');
            const textarea = document.getElementById('log-textarea');
            const editLogBtn = document.getElementById('edit-log-btn');
            
            if (isEditing) {
                // Save the edited log
                const newLogContents = textarea.value;

                fetch('/update_log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ log: newLogContents })
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          loadLog(); // Reload log after saving
                      }
                  });

                // Switch back to view mode
                textarea.style.display = 'none';
                logElement.style.display = 'block';
                editLogBtn.textContent = 'Edit Log';
                editLogBtn.classList.remove('editing');
            } else {
                // Enter edit mode
                fetch('/get_log')
                    .then(response => response.json())
                    .then(data => {
                        textarea.value = data.log_entries.join('');
                    });

                textarea.style.display = 'block';
                logElement.style.display = 'none';
                editLogBtn.textContent = 'Finish Editing';
                editLogBtn.classList.add('editing');
            }

            isEditing = !isEditing; // Toggle editing state
        }
		
		
        // Function to fetch and display the log
        function loadLog() {
			console.log("Refreshing log.");
			
            fetch('/get_log')
                .then(response => response.json())
                .then(data => {
                    const logElement = document.getElementById('log');
                    logElement.innerHTML = data.log_entries.map(entry => `<div>${entry}</div>`).join('');
                });
        };
         
        function addActivity() {
			const time = document.getElementById('time').value;
			const activity = document.getElementById('activity').value;
			const notes = document.getElementById('notes').value;

			console.log("Time:", time);
			console.log("Activity:", activity);
			console.log("Notes:", notes);


			fetch('/add_activity', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ time, activity, notes })
			}).then(response => response.json())
			  .then(data => {
				  if (data.success) {
					  document.getElementById('activity').selectedIndex = 0;
					  document.getElementById('notes').value = '';
				  }
			  })
			  .catch(error => {
				  console.error("Error adding activity:", error);
			  });
		}


        // New function to sort the log
        function sortLog() {
			console.log("Sorting log.")
            fetch('/sort_log', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
					  console.log(data.message);
                      loadLog(); // Reload the log after sorting
                  }
              })
              .catch(error => {
                  console.error("Error sorting log:", error);
              });
        }
        
        // Function to fetch daily stats and update the stats boxes
    function loadDailyStats() {
        fetch('/load_daily_stats')
        .then(response => response.json())
        .then(data => {
            // Update all the stats boxes with the results
            document.getElementById('diaper-stats-box').innerHTML = `<strong>Diapers:</strong><br> ${data.wet_count} Wet<br> ${data.dirty_count} Dirty`;
            document.getElementById('nap-stats-box').innerHTML = `<strong>Time since nap:</strong><br> ${data.time_since_nap} min`;
            document.getElementById('nap-count-box').innerHTML = `<strong># of naps:</strong><br>${data.nap_count}`;
            document.getElementById('nap-time-box').innerHTML = `<strong>Total nap time:</strong><br>${data.total_nap_time} min`;
            document.getElementById('feeding-count-box').innerHTML = `<strong># of Feedings:</strong><br>${data.feeding_count}`;
            document.getElementById('feeding-amount-box').innerHTML = `<strong>Feeding amount:</strong><br>${data.total_feeding_amount} mL`;
        })
        .catch(error => {
            console.error('Error loading daily stats:', error);
        });
    }
        
		console.log("Load log.")
        // Load the log when the page loads
        window.onload = loadLog;
    </script>
</body>
</html>
